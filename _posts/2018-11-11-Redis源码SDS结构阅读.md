---
layout: post
title: "Redis源码SDS结构阅读"
date: 2018-11-11 12:23
categories: [redis]
tags: [redis, C]
---

最近打算跟着<<Redis设计与实现这本书>>把Redis的源码看一遍,成书的时间也比较早,
Redis也一直在发展,所以源码的阅读是参阅的最新版本.

# SDS简介
Redis虽然是基于C语言开发的,但底层字符串的处理,并不是使用原生的char数组,而是对
它进行了简单的封装,称为SDS(simple dynamic string),主要的目的是为了解决在字符串
频繁操作时需要动态分配内存可能导致性能下降的问题.

# SDS数据结构定义
这里参考的源码是SDSLib 2.0,底层定义了几种类型,不过总的思路是一样的,这里择其一种
进行说明:
{% highlight c %}
struct __attribute__ ((__packed__)) sdshdr32 {
    uint32_t len; /* used */
    uint32_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
{% endhighlight %}
+ <strong>\__attribute\__ ((\__packed\__))</strong>: 我们知道为了CPU存取的效率,底层往往会需要进行
                                [结构体对齐][1],这条命令的作用就是告诉编译器
                                在编译优化过程中按照实际字节数进行对齐,这也是
                                接下来的代码中结构体成员偏移地址计算的基础.
+ <strong>char buf[]</strong>: 我们在学习C语言的时候总是被告知数组的大小在编译前是已知的,这里的
              写法岂不是违背了这一原则?其实不然,这是C99引入的[柔性数组][2],很好
              的解决了不定长问题.
+ <strong>unsigned char flags</strong>: 占用一个字节的存储空间,低三位(3 lsb)表示类型,剩下5位未
                       使用.
+ <strong>uint32_t alloc</strong>: 分配的总长度,包括头和结束符.所谓头值得是不包含char buf[]的
                  长度,结束符是C语言字符串的NULL结束符.
+ <strong>len</strong>: 已经使用的长度.


[1]: https://en.wikipedia.org/wiki/Data_structure_alignment/
[2]: https://en.wikipedia.org/wiki/Flexible_array_member/
